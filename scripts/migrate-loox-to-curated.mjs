/**
 * One-time: read existing app/lib/testimonialsFromLoox.ts (old format with full looxTestimonials array),
 * apply same curation as build-loox-testimonials.mjs, write new format (3×30 arrays only).
 * Run: node scripts/migrate-loox-to-curated.mjs
 * No CSV needed. After this, use npm run build:reviews when you have new CSV data.
 */

import { readFileSync, writeFileSync } from "fs";
import { fileURLToPath } from "url";
import { dirname, join } from "path";

const __dirname = dirname(fileURLToPath(import.meta.url));
const ROOT = join(__dirname, "..");
const IN_TS = join(ROOT, "app/lib/testimonialsFromLoox.ts");
const OUT_TS = IN_TS;

const MIN_RATING = 3;
const SET_SIZE = 30;

function shuffle(arr, seed) {
  const out = [...arr];
  let s = seed;
  for (let i = out.length - 1; i > 0; i--) {
    s = (s * 1103515245 + 12345) & 0x7fffffff;
    const j = s % (i + 1);
    [out[i], out[j]] = [out[j], out[i]];
  }
  return out;
}

function buildSet(pool, predicate, seed) {
  const filtered = pool.filter(predicate);
  return shuffle(filtered, seed).slice(0, SET_SIZE);
}

const raw = readFileSync(IN_TS, "utf-8");
const start = raw.indexOf("= [");
if (start === -1) throw new Error("Could not find array in " + IN_TS);
const arrayLiteral = raw.slice(start + 2).trim(); // " [" -> get "[ ... ];"
// Strip trailing "];" and any following (so we have "[ ... ]")
const lastBracket = arrayLiteral.lastIndexOf("];");
const jsonStr =
  lastBracket > 0
    ? arrayLiteral.slice(0, lastBracket + 1)
    : arrayLiteral.replace(/;\s*$/, "");
const testimonials = JSON.parse(jsonStr);

const pool = testimonials.filter((r) => r.rating >= MIN_RATING);
const siteTestimonialsFlow = buildSet(
  pool,
  (r) => r.productType === "flow" || r.productType === "protocol",
  1
);
const clarityOnly = pool.filter((r) => r.productType === "clarity");
const rest = pool.filter((r) => r.productType !== "clarity");
const siteTestimonialsClarity = shuffle([...clarityOnly, ...rest], 2).slice(0, SET_SIZE);
const siteTestimonialsProtocol = buildSet(
  pool,
  (r) => r.productType === "flow" || r.productType === "protocol",
  3
);

const tsContent = `/**
 * Loox testimonials – curated sets only (~90 reviews).
 * Generated by scripts/build-loox-testimonials.mjs from CSV.
 * Do not edit by hand; re-run the script after CSV updates.
 */

export type ProductType = "flow" | "clarity" | "protocol";

export interface LooxTestimonial {
  id: string;
  name: string;
  rating: number;
  date: string;
  headline: string;
  body: string;
  photo?: string;
  photos?: string[];
  productId?: string;
  handle?: string;
  productType: ProductType;
  hasAssets: boolean;
}

export const siteTestimonialsFlow: LooxTestimonial[] = ${JSON.stringify(siteTestimonialsFlow, null, 2)};

export const siteTestimonialsClarity: LooxTestimonial[] = ${JSON.stringify(siteTestimonialsClarity, null, 2)};

export const siteTestimonialsProtocol: LooxTestimonial[] = ${JSON.stringify(siteTestimonialsProtocol, null, 2)};
`;

writeFileSync(OUT_TS, tsContent, "utf-8");
console.log("Wrote", OUT_TS, "–", testimonials.length, "reviews → 3×30 curated");